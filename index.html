<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Unified 5e Sheet v2</title>
    <meta name="theme-color" content="#1e1e1e">
    
    <style>
        :root {
            --bg: #121212;
            --card-bg: #1e1e1e;
            --input-bg: #2d2d2d;
            --accent: #4ecdc4; 
            --accent-atk: #ff6b6b; 
            --gold: #f1c40f; 
            --hp-max: #4a1a1a; 
            --hp-curr: #ef4444; 
            --hp-temp: rgba(59, 130, 246, 0.7); 
            --slot: #9b59b6;  
            --text: #e0e0e0;
            --border: #333;
            --crit: #2ecc71;
            --fail: #e74c3c;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 0; margin: 0; 
            padding-top: 85px; /* Increased for taller header */
            padding-bottom: 50px; 
        }
        .sheet-container { 
            width: 100%; max-width: 800px; margin: 0 auto; padding: 10px; 
            display: flex; flex-direction: column; gap: 15px; box-sizing: border-box; 
        }
        
        /* --- STICKY HEADER --- */
        .roller-bar { 
            background: rgba(30, 30, 30, 0.98);
            backdrop-filter: blur(8px); 
            padding: 8px 15px; 
            border-bottom: 1px solid #444; 
            display: flex; justify-content: space-between; align-items: center; 
            position: fixed; top: 0; left: 0; right: 0; 
            z-index: 1000; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.4); 
            min-height: 70px; /* Taller for 2-line log */
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .roller-bar.insp-active {
            border-bottom: 2px solid var(--gold);
            box-shadow: 0 4px 15px rgba(241, 196, 15, 0.2);
        }
        
        .controls-left { display: flex; align-items: center; gap: 10px; }
        .adv-controls { display: flex; gap: 4px; }
        .adv-btn { 
            background: #333; border: 1px solid #444; color: #888; 
            padding: 0 10px; height: 38px; border-radius: 6px; 
            cursor: pointer; font-weight: bold; font-size: 0.7rem; 
            transition: 0.2s; display: flex; align-items: center;
        }
        .adv-btn.active[data-mode="adv"] { background: #27ae60; color: #fff; border-color: #27ae60; }
        .adv-btn.active[data-mode="dis"] { background: #c0392b; color: #fff; border-color: #c0392b; }
        .adv-btn.active[data-mode="norm"] { background: #2980b9; color: #fff; border-color: #2980b9; }

        .misc-wrapper { 
            display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative;
        }
        .misc-wrapper input { 
            width: 50px !important; height: 30px; text-align: center; font-weight: bold; 
            color: var(--gold); border: 1px solid #444; background: #222; 
            border-radius: 6px; font-size: 1rem; padding: 0; margin-top: 14px;
        }
        .misc-label { 
            font-size: 0.6rem; color: #aaa; text-transform: uppercase; 
            font-weight: 600; position: absolute; top: 0; left: 0; width: 100%; text-align: center;
        }

        /* --- LOG AREA REDESIGN --- */
        .log-area { 
            display: flex; flex-direction: column; align-items: flex-end; justify-content: center;
            flex: 1; text-align: right; margin-left: 15px; overflow: hidden;
            height: 55px;
        }
        .log-formula { font-family: monospace; font-size: 0.8rem; color: #888; white-space: nowrap; margin-bottom: 2px; }
        .log-result { font-family: sans-serif; font-size: 1.8rem; font-weight: 900; line-height: 1; color: var(--accent); }
        .crit-text { color: var(--crit); text-shadow: 0 0 10px rgba(46, 204, 113, 0.3); }
        .fail-text { color: var(--fail); text-shadow: 0 0 10px rgba(231, 76, 60, 0.3); }

        /* --- UI ELEMENTS --- */
        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .section-title { margin: 15px 0 8px 0; color: #888; font-size: 0.85rem; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px; letter-spacing: 0.05em; font-weight: bold; }

        .header-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .field-group { display: flex; flex-direction: column; }
        label { font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 6px; font-weight: 600; }
        
        input[type="text"], input[type="number"], select, textarea { 
            background: var(--input-bg); border: 1px solid var(--border); color: #fff; padding: 10px; 
            border-radius: 6px; font-size: 1rem; width: 100%; box-sizing: border-box; -webkit-appearance: none; 
        }
        input:focus { outline: 2px solid var(--accent); border-color: transparent; }

        /* --- HP & VITALS --- */
        .hp-visual-bar {
            position: relative; width: 100%; height: 24px;
            background-color: var(--hp-max); border-radius: 6px;
            overflow: hidden; margin-bottom: 10px; border: 1px solid #333;
        }
        .hp-fill-curr { background-color: var(--hp-curr); height: 100%; width: 50%; transition: width 0.3s ease; }
        .hp-fill-temp { 
            position: absolute; top: 0; left: 0; height: 100%; width: 0%; 
            background-color: var(--hp-temp); border-right: 2px solid rgba(255,255,255,0.3); transition: width 0.3s ease; 
        }
        .hp-text-overlay { 
            position: absolute; top:0; left:0; width:100%; height:100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: bold; color: #fff; text-shadow: 0 1px 2px #000; pointer-events: none;
        }

        .hp-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
        .hp-box input { text-align: center; font-weight: bold; font-size: 1.2rem; }

        .hp-manage-row {
            display: flex; gap: 10px; margin-top: 10px; align-items: center;
            background: #252525; padding: 10px; border-radius: 8px; border: 1px solid #333;
        }
        #hpInteractVal { width: 80px !important; text-align: center; flex-shrink: 0; }
        .btn-heal { background: #27ae60; color: white; flex: 1; font-weight: bold; }
        .btn-dmg { background: #c0392b; color: white; flex: 1; font-weight: bold; }
        .btn-heal:active, .btn-dmg:active { transform: translateY(1px); opacity: 0.8; }

        /* DEATH SAVES */
        .death-save-row {
            display: grid; grid-template-columns: auto 1fr 1fr auto; gap: 10px; 
            align-items: center; background: #252525; padding: 8px; border-radius: 6px; margin-top: 10px;
            border: 1px solid #333;
        }
        .ds-group { display: flex; gap: 4px; align-items: center; justify-content: center; }
        .ds-check { 
            appearance: none; -webkit-appearance: none;
            width: 16px; height: 16px; border-radius: 50%; 
            border: 2px solid #555; cursor: pointer; background: #1a1a1a;
        }
        .ds-check:checked { box-shadow: 0 0 5px currentColor; border-color: transparent; }
        .ds-succ:checked { background: #2ecc71; color: #2ecc71; }
        .ds-fail:checked { background: #e74c3c; color: #e74c3c; }
        .btn-ds-roll { background: #333; color: #fff; font-size: 0.7rem; font-weight: bold; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        /* REST BUTTONS */
        .rest-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn-rest { flex: 1; background: #2c3e50; color: #ccc; padding: 8px; border-radius: 6px; font-weight: bold; font-size: 0.8rem; cursor: pointer; border: 1px solid #444; }
        .btn-rest:hover { background: #34495e; color: #fff; }

        /* INSPIRATION & PASSIVE */
        .insp-row { 
            display: flex; gap: 10px; margin-top: 10px; align-items: flex-end; 
            background: #252525; padding: 10px; border-radius: 8px; border: 1px solid #333;
        }
        .insp-input-group { flex: 1; display:flex; flex-direction:column; }
        .insp-input { color: var(--gold); border-color: #555; font-weight: bold; text-align: center; font-size: 1.2rem; }
        .btn-use-insp {
            background: var(--gold); color: #000; border: none; padding: 10px 15px; height: 42px;
            border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.85rem; white-space: nowrap;
        }
        
        .passive-row {
            display: flex; justify-content: space-between; align-items: center; 
            background: #1a1a1a; padding: 8px; border-radius: 6px; margin-top: 5px; border: 1px solid #333;
        }
        
        /* --- SPELLS --- */
        .spell-row { 
            display: flex; align-items: center; gap: 10px; margin-bottom: 8px; 
            background: #252525; padding: 8px; border-radius: 8px;
        }
        .spell-lvl { width: 30px; font-weight: bold; color: var(--slot); font-size: 0.9rem; }
        .spell-max { width: 50px !important; text-align: center; padding: 5px; height: 30px; flex-shrink: 0; }
        .spell-bubbles { display: flex; gap: 5px; flex-wrap: wrap; flex: 1; }
        .bubble { 
            width: 20px; height: 20px; border-radius: 50%; border: 2px solid #555; 
            cursor: pointer; background: #1a1a1a;
        }
        .bubble.used { background: var(--slot); border-color: var(--slot); box-shadow: 0 0 5px var(--slot); }

        /* --- DICE --- */
        .dice-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 5px; }
        .dice-btn { 
            background: #333; color: #fff; border: 1px solid #444; padding: 10px; 
            border-radius: 6px; font-weight: bold; cursor: pointer;
        }
        .dice-btn:hover { background: var(--accent); color: #000; }
        .custom-roll-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn-roll-custom { background: var(--accent); color: #000; font-weight: bold; border:none; padding: 0 20px; border-radius: 6px; cursor: pointer;}
        
        /* --- STATS & SAVES --- */
        .grid-6 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .stat-card { background: var(--card-bg); padding: 8px; border-radius: 8px; text-align: center; border: 1px solid var(--border); display: flex; flex-direction: column; }
        .stat-card h3 { margin: 0 0 2px 0; font-size: 0.8rem; color: #aaa; }
        .score-input { width: 100% !important; text-align: center; font-size: 1.1rem; font-weight: bold; margin-bottom: 2px; padding: 4px !important; background: transparent !important; border: none !important; color: #fff !important; }
        .mod-display { font-size: 0.85rem; color: #888; margin-bottom: 4px; }
        .defense-box { background: #252525; padding: 2px; border-radius: 4px; border-top: 2px solid var(--accent); margin-top: 4px; flex-grow: 1; }
        .defense-val { font-size: 1.1rem; font-weight: bold; color: var(--accent); }
        .save-prof { 
            font-size: 0.65rem; font-weight: bold; color: #888; 
            display: flex; justify-content: center; align-items: center; gap: 6px; 
            margin-bottom: 2px; cursor: pointer; white-space: nowrap;
        }
        .read-only-box {
            background: transparent; border: 1px solid transparent; color: #fff; 
            font-weight: bold; padding: 10px; font-size: 1rem;
        }
        .stat-btn-row { display: flex; gap: 5px; margin-top: 6px; width: 100%; }
        .btn-sm-roll { flex: 1; background: #333; color: #ccc; border: 1px solid #444; border-radius: 4px; font-size: 0.7rem; font-weight: bold; padding: 6px 0; cursor: pointer; text-transform: uppercase; }
        .btn-sm-roll:hover { background: #444; color: white; }
        .btn-sm-save { flex: 1; background: #2c3e50; color: #fff; border: 1px solid #444; border-radius: 4px; font-size: 0.7rem; font-weight: bold; padding: 6px 0; cursor: pointer; text-transform: uppercase; }
        .btn-sm-save:hover { background: var(--accent); color: #000; }

        /* --- SKILLS --- */
        .skill-list { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .skill-row { background: var(--card-bg); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--border); }
        .skill-name { flex: 1; font-size: 0.95rem; font-weight: 500; }
        .prof-toggle { font-size: 1.2rem; padding: 5px; cursor: pointer; } 
        .prof-toggle.prof { color: var(--accent); }
        .prof-toggle.exp { color: var(--gold); }
        .btn-roll-skill {
            background: #333; border: 1px solid #444; color: #fff;
            width: 40px; height: 40px; border-radius: 6px; font-size: 1.2rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-roll-skill:active { background: var(--accent); color: #000; }

        .atk-row { 
            display: flex; flex-direction: column; gap: 8px; 
            margin-bottom: 15px; background: #252525; padding: 10px; 
            border-radius: 8px; border: 1px solid #333; 
        }
        .atk-top { display: grid; grid-template-columns: 1fr 70px 60px; gap: 8px; }
        .atk-desc { 
            font-size: 0.85rem; font-style: italic; color: #aaa; 
            border: none; border-bottom: 1px solid #444; background: transparent; 
            padding: 5px; border-radius: 0; 
        }
        .atk-desc:focus { outline: none; border-bottom-color: var(--accent); }
        .atk-controls { display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; }
        
        button { border: none; border-radius: 6px; font-weight: bold; cursor: pointer; height: 40px; font-size: 0.9rem; }
        .add-btn { background: var(--accent-atk); color: #000; width: 100%; margin-top: 5px; }

        .webhook-row { grid-column: span 2; margin-top: 5px; padding-top: 10px; border-top: 1px solid #333; }
        .discord-active { color: #5865F2; font-weight: bold; }

        @media (max-width: 600px) {
            .header-grid { grid-template-columns: 1fr; }
            .webhook-row { grid-column: span 1; }
            .log-area { max-width: 140px; margin-left: 10px; }
            .log-result { font-size: 1.5rem; }
            .hp-grid { grid-template-columns: 1fr 1fr; } 
        }
    </style>
</head>
<body>

<div class="roller-bar" id="rollerBar">
    <div class="controls-left">
        <div class="adv-controls">
            <button class="adv-btn" onclick="setMode('dis')" data-mode="dis">DIS</button>
            <button class="adv-btn active" onclick="setMode('norm')" data-mode="norm"> - </button>
            <button class="adv-btn" onclick="setMode('adv')" data-mode="adv">ADV</button>
        </div>
        <div class="misc-wrapper">
            <span class="misc-label">Misc</span>
            <input type="number" id="globalMisc" placeholder="0">
        </div>
    </div>
    <div id="logArea" class="log-area">
        <div class="log-formula">Ready...</div>
        <div class="log-result">-</div>
    </div>
</div>

<div class="sheet-container">
    
    <div class="card">
        <div class="header-grid">
            <div class="field-group">
                <label>Player Name</label>
                <input type="text" id="playerName" placeholder="Your Name" oninput="save()">
            </div>
            <div class="field-group">
                <label>Character Name</label>
                <input type="text" id="charName" placeholder="Character Name" oninput="save()">
            </div>
            
            <div class="webhook-row" style="border:none; padding:0; margin:0; grid-column: span 2;">
                <div class="section-title" style="margin-top:0;">Vitals (HP)</div>
                <div class="hp-visual-bar">
                    <div class="hp-fill-curr" id="barCurr"></div>
                    <div class="hp-fill-temp" id="barTemp"></div>
                    <div class="hp-text-overlay" id="barText"></div>
                </div>
                <div class="hp-grid">
                    <div class="field-group hp-box">
                        <label>Current</label>
                        <input type="number" id="hpCurr" style="color:#ef4444; border-color:#ef4444;" placeholder="0" oninput="updateHP()">
                    </div>
                    <div class="field-group hp-box">
                        <label>Max</label>
                        <input type="number" id="hpMax" placeholder="0" oninput="updateHP()">
                    </div>
                    <div class="field-group hp-box">
                        <label>Temp</label>
                        <input type="number" id="hpTemp" style="color:#3498db; border-color:#3498db;" placeholder="0" oninput="updateHP()">
                    </div>
                    <div class="field-group hp-box">
                        <label>Hit Dice</label>
                        <input type="text" id="hitDice" placeholder="1d8" oninput="save()">
                    </div>
                </div>

                <div class="hp-manage-row">
                    <input type="number" id="hpInteractVal" placeholder="Amount">
                    <button class="btn-dmg" onclick="applyDamage()">Damage Me</button>
                    <button class="btn-heal" onclick="applyHeal()">Heal</button>
                </div>
                
                <div class="death-save-row" id="deathSaveRow" style="display:none;">
                    <button class="btn-ds-roll" onclick="rollDeathSave()">Roll DS</button>
                    <div class="ds-group">
                        <span style="font-size:0.6rem; color:#2ecc71;">SUCC</span>
                        <input type="checkbox" class="ds-check ds-succ" id="ds-s1" onchange="save()">
                        <input type="checkbox" class="ds-check ds-succ" id="ds-s2" onchange="save()">
                        <input type="checkbox" class="ds-check ds-succ" id="ds-s3" onchange="save()">
                    </div>
                    <div class="ds-group">
                        <span style="font-size:0.6rem; color:#e74c3c;">FAIL</span>
                        <input type="checkbox" class="ds-check ds-fail" id="ds-f1" onchange="save()">
                        <input type="checkbox" class="ds-check ds-fail" id="ds-f2" onchange="save()">
                        <input type="checkbox" class="ds-check ds-fail" id="ds-f3" onchange="save()">
                    </div>
                    <div style="font-size:0.7rem; font-weight:bold; color:#888;">DEATH<br>SAVES</div>
                </div>

                <div class="rest-row">
                    <button class="btn-rest" onclick="shortRest()">Short Rest (Hit Die)</button>
                    <button class="btn-rest" onclick="longRest()">Long Rest (Reset)</button>
                </div>

            </div>

            <div class="webhook-row" style="border-top:none; padding-top:0;">
                <div class="insp-row">
                    <div class="insp-input-group">
                        <label style="color:#aaa; font-size:0.75rem; text-transform:uppercase;">Inspiration</label>
                        <input type="number" id="inspirationVal" class="insp-input" value="0" placeholder="0" oninput="save()">
                    </div>
                    <button class="btn-use-insp" onclick="useInspiration()">Use (Next d20)</button>
                </div>
            </div>

            <div class="field-group">
                <label>Level</label>
                <input type="number" id="charLevel" value="1" min="1" max="20" oninput="updateLevel(this.value)">
            </div>
            <div class="field-group">
                <label>Prof. Bonus</label>
                <div class="read-only-box" id="charPB">+2</div>
            </div>
            
            <div class="field-group" style="grid-column: span 2;">
                <div class="passive-row">
                    <span style="color:#888; font-weight:bold; font-size:0.9rem;">Passive Perception</span>
                    <span id="passivePerc" style="color:#fff; font-weight:bold; font-size:1.1rem;">10</span>
                </div>
            </div>

            <div class="webhook-row">
                <input type="text" id="webhookUrl" placeholder="Discord Webhook URL..." oninput="save()">
                <label class="discord-toggle" id="discordLabel" style="display:flex; align-items:center; gap:8px; margin-top:5px; color:#aaa; font-size:0.9rem;">
                    <input type="checkbox" id="sendToDiscord" onchange="toggleDiscord(this.checked)"> 
                    <span>Active (Send to Discord)</span>
                </label>
            </div>
        </div>
    </div>

    <div>
        <div class="section-title">Attributes</div>
        <div class="grid-6" id="statsGrid"></div>
    </div>

    <div>
        <div class="section-title">Attacks</div>
        <div id="attackList"></div>
        <button class="add-btn" onclick="addAttack()">+ Add Weapon / Spell</button>
    </div>

    <div class="card">
        <div class="section-title" style="margin-top:0;">Spell Slots</div>
        <div id="spellSlotsList"></div>
    </div>

    <div>
        <div class="section-title">Skills</div>
        <div class="skill-list" id="skillGrid"></div>
    </div>

    <div class="card">
        <div class="section-title" style="margin-top:0;">Arbitrary Roller</div>
        <div class="custom-roll-row" style="margin-bottom:10px;">
             <input type="text" id="customLabel" placeholder="Optional Label (e.g. Healing Potion)">
        </div>
        <div class="dice-grid">
            <button class="dice-btn" onclick="rollDie(4,0,'d4',false,'check')">d4</button>
            <button class="dice-btn" onclick="rollDie(6,0,'d6',false,'check')">d6</button>
            <button class="dice-btn" onclick="rollDie(8,0,'d8',false,'check')">d8</button>
            <button class="dice-btn" onclick="rollDie(10,0,'d10',false,'check')">d10</button>
            <button class="dice-btn" onclick="rollDie(12,0,'d12',false,'check')">d12</button>
            <button class="dice-btn" onclick="rollDie(20,0,'d20',true,'check')">d20</button>
            <button class="dice-btn" onclick="rollDie(100,0,'d100',false,'check')">d100</button>
        </div>
        <div class="custom-roll-row">
            <input type="text" id="customFormula" placeholder="e.g. 2d6+4">
            <button class="btn-roll-custom" onclick="rollCustom()">Roll</button>
        </div>
    </div>

    <div class="card io-card" style="margin-top:20px;">
        <div class="section-title" style="margin-top:0;">Backup Data</div>
        <textarea id="ioField" rows="2" placeholder="Save string..." style="width:100%; font-family:monospace; color:var(--accent); resize:none;"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button style="flex:1; background:#333; color:#ccc;" onclick="exportData()">Copy Save</button>
            <button style="flex:1; background:var(--accent); color:#000;" onclick="importData()">Load Save</button>
        </div>
        <div id="ioMsg" style="text-align:center; color: var(--accent); font-size:0.8rem; margin-top:8px;"></div>
    </div>

</div>

<script>
    const stats = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
    const skillsMap = {
        'acrobatics': 'dex', 'animal handling': 'wis', 'arcana': 'int', 'athletics': 'str', 
        'deception': 'cha', 'history': 'int', 'insight': 'wis', 'intimidation': 'cha', 
        'investigation': 'int', 'medicine': 'wis', 'nature': 'int', 'perception': 'wis', 
        'performance': 'cha', 'persuasion': 'cha', 'religion': 'int', 'sleight of hand': 'dex', 
        'stealth': 'dex', 'survival': 'wis'
    };

    let data = {
        meta: { player: '', name: '', level: 1, webhook: '', discordActive: false },
        vitals: { curr: '', max: '', temp: '', hitDice: '', inspiration: 0, ds: {s1:false, s2:false, s3:false, f1:false, f2:false, f3:false} },
        stats: { str: {val:10,save:false}, dex: {val:10,save:false}, con: {val:10,save:false}, int: {val:10,save:false}, wis: {val:10,save:false}, cha: {val:10,save:false} },
        skills: {}, attacks: [], spells: [], rollMode: 'norm'
    };
    
    let consumeInspirationOnNextRoll = false;

    function init() {
        const saved = localStorage.getItem('unifiedSheetDataV2'); 
        
        let defaultSpells = [];
        for(let i=1; i<=9; i++) defaultSpells.push({ lvl: i, max: 0, used: 0 });

        if (saved) {
            const parsed = JSON.parse(saved);
            data = { ...data, ...parsed };
            // Merge deep objects to avoid overwriting new fields
            if(parsed.meta) data.meta = {...data.meta, ...parsed.meta};
            if(parsed.vitals) data.vitals = {...data.vitals, ...parsed.vitals};
            if(!data.vitals.ds) data.vitals.ds = {s1:false, s2:false, s3:false, f1:false, f2:false, f3:false};
            if(parsed.stats) data.stats = {...data.stats, ...parsed.stats};
            if(!data.spells || data.spells.length === 0) data.spells = defaultSpells;
        } else {
            Object.keys(skillsMap).forEach(s => data.skills[s] = 0);
            data.spells = defaultSpells;
        }

        document.getElementById('playerName').value = data.meta.player || '';
        document.getElementById('charName').value = data.meta.name || '';
        document.getElementById('charLevel').value = data.meta.level || 1;
        document.getElementById('webhookUrl').value = data.meta.webhook || '';
        document.getElementById('sendToDiscord').checked = data.meta.discordActive || false;
        toggleDiscord(data.meta.discordActive);

        document.getElementById('hpCurr').value = data.vitals.curr || '';
        document.getElementById('hpMax').value = data.vitals.max || '';
        document.getElementById('hpTemp').value = data.vitals.temp || '';
        document.getElementById('hitDice').value = data.vitals.hitDice || '';
        document.getElementById('inspirationVal').value = data.vitals.inspiration || 0;
        
        // Death Saves
        document.getElementById('ds-s1').checked = data.vitals.ds.s1;
        document.getElementById('ds-s2').checked = data.vitals.ds.s2;
        document.getElementById('ds-s3').checked = data.vitals.ds.s3;
        document.getElementById('ds-f1').checked = data.vitals.ds.f1;
        document.getElementById('ds-f2').checked = data.vitals.ds.f2;
        document.getElementById('ds-f3').checked = data.vitals.ds.f3;

        updateHP(); 
        renderStats();
        renderSkills();
        renderAttacks();
        renderSpells();
        updateAll();
        setMode(data.rollMode || 'norm');
    }

    // --- RENDERERS ---
    function renderStats() {
        document.getElementById('statsGrid').innerHTML = stats.map(s => `
            <div class="stat-card">
                <h3>${s.toUpperCase()}</h3>
                <input type="number" class="score-input" value="${data.stats[s].val}" onchange="updateStat('${s}', this.value)">
                <div class="mod-display" id="mod-${s}">+0</div>
                <div class="save-prof" onclick="toggleSave('${s}', event)"><input type="checkbox" ${data.stats[s].save ? 'checked' : ''}> Def Prof</div>
                <div class="defense-box"><div class="defense-val" id="def-${s}">11</div></div>
                
                <div class="stat-btn-row">
                    <button class="btn-sm-roll" onclick="rollCheck('${s}')">Check</button>
                    <button class="btn-sm-save" onclick="rollSave('${s}')">Save</button>
                </div>
            </div>
        `).join('');
    }

    function renderSkills() {
        document.getElementById('skillGrid').innerHTML = Object.keys(skillsMap).map(s => {
            const state = data.skills[s] || 0; 
            const icon = state === 2 ? 'â—ˆ' : (state === 1 ? 'â—†' : 'â—‡');
            const cls = state === 2 ? 'exp' : (state === 1 ? 'prof' : '');
            return `
            <div class="skill-row">
                <span class="prof-toggle ${cls}" onclick="cycleSkill('${s}')">${icon}</span>
                <span class="skill-name">${s.charAt(0).toUpperCase() + s.slice(1)}</span>
                <span style="font-weight:bold; color:#ddd;" id="skill-bonus-${s}">+0</span>
                <button class="btn-roll-skill" onclick="rollSkill('${s}')">ðŸŽ²</button>
            </div>`;
        }).join('');
    }

    function renderAttacks() {
        document.getElementById('attackList').innerHTML = data.attacks.map((atk, i) => `
            <div class="atk-row">
                <div class="atk-top">
                    <input type="text" placeholder="Weapon" value="${atk.name}" onchange="updateAttack(${i}, 'name', this.value)">
                    <input type="text" placeholder="1d8" value="${atk.dmg}" onchange="updateAttack(${i}, 'dmg', this.value)">
                    <select onchange="updateAttack(${i}, 'stat', this.value)">
                        <option value="none" ${atk.stat === 'none' ? 'selected' : ''}>NONE</option>
                        ${stats.map(s => `<option value="${s}" ${atk.stat === s ? 'selected' : ''}>${s.toUpperCase()}</option>`).join('')}
                    </select>
                </div>
                <input class="atk-desc" placeholder="Attack description / effect..." value="${atk.desc || ''}" onchange="updateAttack(${i}, 'desc', this.value)">
                <div class="atk-controls">
                    <button style="background:var(--accent); color:#000;" onclick="rollAttack(${i})">Atk</button>
                    <button style="background:#333; color:#ccc; border:1px solid #444;" onclick="rollDamage(${i})">Dmg</button>
                    <button style="background:transparent; color:#666; font-size:1.5rem;" onclick="delAttack(${i})">&times;</button>
                </div>
            </div>
        `).join('');
    }

    function renderSpells() {
        const list = document.getElementById('spellSlotsList');
        list.innerHTML = '';
        data.spells.forEach((slot, idx) => {
            let bubblesHtml = '';
            for(let i=0; i<slot.max; i++) {
                const isUsed = i < slot.used;
                bubblesHtml += `<div class="bubble ${isUsed ? 'used' : ''}" onclick="toggleSpellSlot(${idx}, ${i})"></div>`;
            }
            
            const div = document.createElement('div');
            div.className = 'spell-row';
            div.innerHTML = `
                <div class="spell-lvl">Lvl ${slot.lvl}</div>
                <input type="number" class="spell-max" value="${slot.max}" placeholder="0" onchange="updateSpellMax(${idx}, this.value)">
                <div class="spell-bubbles">${bubblesHtml}</div>
            `;
            list.appendChild(div);
        });
    }

    // --- LOGIC ---
    function getMod(score) { return Math.floor((score - 10) / 2); }
    function getPB(level) { return Math.ceil(level / 4) + 1; }

    function updateLevel(val) { data.meta.level = Math.min(20, Math.max(1, parseInt(val))); save(); updateAll(); }

    function updateAll() {
        const pb = getPB(data.meta.level);
        document.getElementById('charPB').innerText = "+" + pb;
        stats.forEach(s => {
            const mod = getMod(data.stats[s].val);
            const saveBonus = mod + (data.stats[s].save ? pb : 0);
            document.getElementById(`mod-${s}`).innerText = (mod >= 0 ? "+" : "") + mod;
            document.getElementById(`def-${s}`).innerText = 11 + saveBonus;
        });
        Object.keys(skillsMap).forEach(s => {
            const stat = skillsMap[s];
            const mod = getMod(data.stats[stat].val);
            const profLevel = data.skills[s] || 0;
            const bonus = mod + (profLevel * pb);
            document.getElementById(`skill-bonus-${s}`).innerText = (bonus >= 0 ? "+" : "") + bonus;
        });
        
        // Passive Perception
        const wisMod = getMod(data.stats.wis.val);
        const percProf = data.skills['perception'] || 0;
        const passPerc = 10 + wisMod + (percProf * pb);
        document.getElementById('passivePerc').innerText = passPerc;
    }

    // --- HP BAR & MANAGEMENT LOGIC ---
    function updateHP() {
        const curr = parseInt(document.getElementById('hpCurr').value) || 0;
        const max = parseInt(document.getElementById('hpMax').value) || 0;
        const temp = parseInt(document.getElementById('hpTemp').value) || 0;
        
        let currPct = 0;
        if(max > 0) currPct = (curr / max) * 100;
        if(currPct > 100) currPct = 100; if(currPct < 0) currPct = 0;
        
        let tempPct = 0;
        if(max > 0) tempPct = (temp / max) * 100;
        if(tempPct > 100) tempPct = 100;
        
        document.getElementById('barCurr').style.width = currPct + "%";
        document.getElementById('barTemp').style.width = tempPct + "%";
        document.getElementById('barText').innerText = `${curr} / ${max}` + (temp > 0 ? ` (+${temp})` : "");
        
        // Auto-show Death Saves if 0 HP
        const dsRow = document.getElementById('deathSaveRow');
        if (curr <= 0 && max > 0) dsRow.style.display = 'grid';
        else dsRow.style.display = 'none';

        save();
    }

    function applyDamage() {
        let amt = parseInt(document.getElementById('hpInteractVal').value) || 0;
        if (amt <= 0) return;
        let temp = parseInt(document.getElementById('hpTemp').value) || 0;
        let curr = parseInt(document.getElementById('hpCurr').value) || 0;

        if (temp > 0) {
            if (amt >= temp) { amt -= temp; temp = 0; } 
            else { temp -= amt; amt = 0; }
        }
        curr -= amt;
        if (curr < 0) curr = 0;

        document.getElementById('hpTemp').value = temp;
        document.getElementById('hpCurr').value = curr;
        document.getElementById('hpInteractVal').value = ''; 
        updateHP();
    }

    function applyHeal() {
        let amt = parseInt(document.getElementById('hpInteractVal').value) || 0;
        if (amt <= 0) return;
        let curr = parseInt(document.getElementById('hpCurr').value) || 0;
        let max = parseInt(document.getElementById('hpMax').value) || 0;
        curr += amt;
        if (max > 0 && curr > max) curr = max;
        document.getElementById('hpCurr').value = curr;
        document.getElementById('hpInteractVal').value = ''; 
        updateHP();
    }
    
    // --- REST SYSTEM ---
    function shortRest() {
        const hitDice = document.getElementById('hitDice').value || "No Hit Dice Set";
        const amt = prompt(`SHORT REST\n\nYou have ${hitDice}.\nEnter HP amount rolled to heal:`);
        if (amt) {
            document.getElementById('hpInteractVal').value = amt;
            applyHeal();
        }
    }
    
    function longRest() {
        if(!confirm("LONG REST\n\nReset HP, Hit Dice, Spell Slots and Death Saves?")) return;
        
        // Reset HP
        document.getElementById('hpCurr').value = document.getElementById('hpMax').value;
        document.getElementById('hpTemp').value = 0;
        
        // Reset Spells
        data.spells.forEach(s => s.used = 0);
        
        // Reset Death Saves
        data.vitals.ds = {s1:false, s2:false, s3:false, f1:false, f2:false, f3:false};
        
        save();
        init(); // Re-render everything
    }

    // --- INSPIRATION ---
    function useInspiration() {
        let val = parseInt(document.getElementById('inspirationVal').value) || 0;
        if(val <= 0) { showLog("No Insp!", "0"); return; }
        val--;
        document.getElementById('inspirationVal').value = val;
        data.vitals.inspiration = val;
        save();
        consumeInspirationOnNextRoll = true;
        setMode('adv');
        document.getElementById('rollerBar').classList.add('insp-active');
        showLog("Inspiration!", "Active");
    }
    
    function consumeInspiration() {
        if(consumeInspirationOnNextRoll) { 
            consumeInspirationOnNextRoll = false; 
            setMode('norm'); 
            document.getElementById('rollerBar').classList.remove('insp-active');
        }
    }

    // --- SPELLS ---
    function updateSpellMax(idx, val) {
        data.spells[idx].max = parseInt(val) || 0;
        if(data.spells[idx].used > data.spells[idx].max) data.spells[idx].used = data.spells[idx].max;
        save(); renderSpells();
    }
    function toggleSpellSlot(idx, bubbleIdx) {
        const currentUsed = data.spells[idx].used;
        if (bubbleIdx + 1 === currentUsed) { data.spells[idx].used = bubbleIdx; } 
        else { data.spells[idx].used = bubbleIdx + 1; }
        save(); renderSpells();
    }

    function setMode(mode) {
        data.rollMode = mode;
        save(); 
        document.querySelectorAll('.adv-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.adv-btn[data-mode="${mode}"]`).classList.add('active');
    }

    // --- ROLLING LOGIC ---
    function showLog(formula, result, isCrit = false, isFail = false) {
        const logArea = document.getElementById('logArea');
        let resClass = 'log-result';
        if(isCrit) resClass += ' crit-text';
        if(isFail) resClass += ' fail-text';
        
        logArea.innerHTML = `
            <div class="log-formula">${formula}</div>
            <div class="${resClass}">${result}</div>
        `;
    }

    function rollDie(sides, bonus, label, allowAdvantage = true, type = 'check', customDesc = '') {
        const miscInput = document.getElementById('globalMisc');
        const misc = parseInt(miscInput.value) || 0;
        
        // Inspiration Check
        let effectiveMode = data.rollMode;
        let consumedInsp = false;
        
        // Only use advantage logic if allowAdvantage is true (d20 stuff)
        if(allowAdvantage && consumeInspirationOnNextRoll) {
            effectiveMode = 'adv';
            consumedInsp = true;
        }

        let r1 = Math.floor(Math.random() * sides) + 1;
        let r2 = Math.floor(Math.random() * sides) + 1;
        let roll = r1;
        let formulaBase = `[${r1}]`;
        let modeStr = "";

        if (allowAdvantage && sides === 20) {
            if (effectiveMode === 'adv') {
                roll = Math.max(r1, r2);
                formulaBase = `[${r1}, ${r2}] (High)`;
                modeStr = " (ADV)";
            } else if (effectiveMode === 'dis') {
                roll = Math.min(r1, r2);
                formulaBase = `[${r1}, ${r2}] (Low)`;
                modeStr = " (DIS)";
            }
        }

        const total = roll + bonus + misc;
        
        let formulaText = `${formulaBase}`;
        if(bonus !== 0) formulaText += ` ${bonus>=0?'+':''}${bonus}`;
        if(misc !== 0) formulaText += ` ${misc>=0?'+':''}${misc} (Misc)`;
        if(modeStr) formulaText += modeStr;

        const isCrit = (sides === 20 && roll === 20);
        const isFail = (sides === 20 && roll === 1);

        showLog(formulaText, total, isCrit, isFail);
        
        sendToDiscord(label + modeStr, `Dice: ${formulaText}`, `**${total}**`, type, customDesc);
        
        if(consumedInsp) consumeInspiration();
    }

    function rollCustom() {
        const formula = document.getElementById('customFormula').value.trim();
        const label = document.getElementById('customLabel').value.trim() || 'Custom Roll';
        if(!formula) return;
        
        const regex = /^(\d+)?d(\d+)\s*([+-]\s*\d+)?$/i;
        const match = formula.match(regex);
        if(!match) { showLog("Error", "Invalid"); return; }

        const count = parseInt(match[1]) || 1;
        const sides = parseInt(match[2]);
        const modStr = match[3] ? match[3].replace(/\s/g, '') : "+0";
        const mod = parseInt(modStr);

        let total = 0;
        let rolls = [];
        for(let i=0; i<count; i++) {
            let r = Math.floor(Math.random() * sides) + 1;
            total += r;
            rolls.push(r);
        }
        total += mod;

        showLog(`[${rolls.join('+')}] ${modStr}`, total);
        sendToDiscord(label + ": " + formula, `Dice: [${rolls.join('+')}] ${modStr}`, `**${total}**`, 'dmg');
    }

    function rollDamage(idx) {
        const atk = data.attacks[idx];
        let mod = 0;
        if (atk.stat !== 'none') { mod = getMod(data.stats[atk.stat].val); }
        const dmgStr = atk.dmg || "1d4"; 
        const regex = /(\d+)d(\d+)/i;
        const match = dmgStr.match(regex);
        if (!match) return; 

        const count = parseInt(match[1]);
        const sides = parseInt(match[2]);
        let total = 0;
        let rolls = [];
        for (let i = 0; i < count; i++) {
            let r = Math.floor(Math.random() * sides) + 1;
            total += r;
            rolls.push(r);
        }
        total += mod;
        
        const formulaStr = `[${rolls.join('+')}] ${mod>=0?'+':''}${mod}`;
        showLog(formulaStr, total);
        sendToDiscord((atk.name || 'Weapon') + " Damage", `Dice: ${formulaStr}`, `**${total}**`, 'dmg', atk.desc);
    }

    function rollDeathSave() {
        const r = Math.floor(Math.random() * 20) + 1;
        let msg = "Failure";
        let isCrit = false; let isFail = false;
        
        if (r === 20) { 
            msg = "Regain 1 HP!"; isCrit = true; 
            // Auto heal 1
            document.getElementById('hpCurr').value = 1; 
            updateHP();
        } else if (r === 1) {
            msg = "2 Failures"; isFail = true;
            addDeathFail(); addDeathFail();
        } else if (r >= 10) {
            msg = "Success"; isCrit = true;
            addDeathSuccess();
        } else {
            msg = "Failure"; isFail = true;
            addDeathFail();
        }
        
        showLog("Death Save", r, isCrit, isFail);
        sendToDiscord("Death Save", `Rolled: ${r}`, `**${msg}**`, 'save');
    }
    
    function addDeathSuccess() {
        const d = data.vitals.ds;
        if(!d.s1) d.s1 = true; else if(!d.s2) d.s2 = true; else if(!d.s3) d.s3 = true;
        save(); init();
    }
    function addDeathFail() {
        const d = data.vitals.ds;
        if(!d.f1) d.f1 = true; else if(!d.f2) d.f2 = true; else if(!d.f3) d.f3 = true;
        save(); init();
    }

    // --- WRAPPERS ---
    function rollCheck(stat) { rollDie(20, getMod(data.stats[stat].val), stat.toUpperCase() + " Check", true, 'check'); }
    
    function rollSave(stat) {
        const pb = getPB(data.meta.level);
        const mod = getMod(data.stats[stat].val);
        const isProf = data.stats[stat].save;
        const totalBonus = mod + (isProf ? pb : 0);
        rollDie(20, totalBonus, stat.toUpperCase() + " Save", true, 'save'); 
    }

    function rollSkill(skill) {
        const stat = skillsMap[skill];
        const pb = getPB(data.meta.level);
        const mod = getMod(data.stats[stat].val);
        const profLevel = data.skills[skill] || 0;
        rollDie(20, mod + (profLevel * pb), skill.charAt(0).toUpperCase() + skill.slice(1), true, 'check');
    }
    function rollAttack(idx) {
        const atk = data.attacks[idx];
        const pb = getPB(data.meta.level);
        let mod = 0;
        if (atk.stat !== 'none') { mod = getMod(data.stats[atk.stat].val); }
        rollDie(20, mod + pb, (atk.name || 'Weapon') + " Atk", true, 'atk', atk.desc);
    }

    // --- DATA & IO ---
    function updateStat(stat, val) { data.stats[stat].val = parseInt(val); save(); updateAll(); }
    function toggleSave(stat, e) { 
        if(e.target.tagName !== 'INPUT') { data.stats[stat].save = !data.stats[stat].save; save(); renderStats(); updateAll(); } 
        else { data.stats[stat].save = e.target.checked; save(); updateAll(); }
    }
    function cycleSkill(skill) { data.skills[skill] = ( (data.skills[skill] || 0) + 1) % 3; save(); renderSkills(); updateAll(); }
    function addAttack() { data.attacks.push({ name: '', stat: 'str', dmg: '1d8', desc: '' }); save(); renderAttacks(); }
    function updateAttack(idx, field, val) { data.attacks[idx][field] = val; save(); }
    function delAttack(idx) { data.attacks.splice(idx, 1); save(); renderAttacks(); }
    
    function toggleDiscord(active) {
        data.meta.discordActive = active;
        const label = document.getElementById('discordLabel');
        if(active) label.classList.add('discord-active'); else label.classList.remove('discord-active');
        save();
    }
    
    function sendToDiscord(label, formulaStr, result, type = 'check', customDesc = '') {
        if (!data.meta.discordActive || !data.meta.webhook) return;
        let color = 5164484; 
        if (type === 'atk') color = 16739179; 
        if (type === 'dmg') color = 9807270; 
        if (type === 'save') color = 3066993; 
        
        let descText = `**Result:** ${result}\n\n${formulaStr}`;
        if (customDesc) descText = `*${customDesc}*\n\n` + descText;

        const payload = {
            username: data.meta.name || "Character",
            embeds: [{ title: label, description: descText, color: color, footer: { text: `Player: ${data.meta.player}` } }]
        };
        fetch(data.meta.webhook, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).catch(err => console.error(err));
    }
    
    function save() { 
        data.meta.player = document.getElementById('playerName').value;
        data.meta.name = document.getElementById('charName').value;
        data.meta.webhook = document.getElementById('webhookUrl').value;
        data.vitals.curr = document.getElementById('hpCurr').value;
        data.vitals.max = document.getElementById('hpMax').value;
        data.vitals.temp = document.getElementById('hpTemp').value;
        data.vitals.hitDice = document.getElementById('hitDice').value;
        data.vitals.inspiration = parseInt(document.getElementById('inspirationVal').value) || 0;
        
        // Save DS
        if(document.getElementById('ds-s1')) {
            data.vitals.ds = {
                s1: document.getElementById('ds-s1').checked,
                s2: document.getElementById('ds-s2').checked,
                s3: document.getElementById('ds-s3').checked,
                f1: document.getElementById('ds-f1').checked,
                f2: document.getElementById('ds-f2').checked,
                f3: document.getElementById('ds-f3').checked,
            };
        }

        localStorage.setItem('unifiedSheetDataV2', JSON.stringify(data)); 
    }

    function showIoMsg(txt) { document.getElementById('ioMsg').innerText = txt; setTimeout(() => document.getElementById('ioMsg').innerText = "", 3000); }
    function exportData() {
        save();
        try {
            const jsonStr = JSON.stringify(data);
            const base64 = btoa(encodeURIComponent(jsonStr).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));
            const field = document.getElementById('ioField'); field.value = base64; field.select(); field.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(base64).then(() => showIoMsg("Copied!"));
        } catch(e) { showIoMsg("Error"); }
    }
    function importData() {
        const field = document.getElementById('ioField'); const str = field.value.trim();
        if(!str) return showIoMsg("Empty!");
        try {
            const jsonStr = decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            const parsed = JSON.parse(jsonStr);
            data = parsed; 
            save(); init(); field.value = ""; showIoMsg("Loaded!");
        } catch(e) { showIoMsg("Invalid Code"); console.error(e); }
    }

    init();
</script>
</body>
</html>
