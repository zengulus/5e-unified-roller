<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified 5e Sheet (Discord Ready)</title>
    <meta property="og:title" content="Unified 5e Character Sheet">
    <meta property="og:description" content="Tiered Competence & Unified Offense roller with direct Discord integration.">
    <meta property="og:type" content="website">
    <meta name="theme-color" content="#4ecdc4">
    
    <style>
        :root {
            --bg: #121212;
            --card-bg: #1e1e1e;
            --input-bg: #2d2d2d;
            --accent: #4ecdc4; /* Cyan */
            --accent-atk: #ff6b6b; /* Red */
            --misc: #f1c40f; /* Yellow */
            --text: #e0e0e0;
            --border: #333;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; display: flex; justify-content: center; padding-top: 80px; padding-bottom: 50px; }
        .sheet-container { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 20px; }
        
        /* STICKY HEADER */
        .roller-bar { background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); padding: 10px 20px; border-radius: 0 0 12px 12px; display: flex; gap: 15px; align-items: center; position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 800px; z-index: 100; border-bottom: 1px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.5); box-sizing: border-box; flex-wrap: wrap; }
        
        .adv-controls { display: flex; gap: 5px; }
        .adv-btn { background: #333; border: none; color: #888; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8rem; transition: 0.2s; }
        .adv-btn.active[data-mode="adv"] { background: #27ae60; color: #fff; box-shadow: 0 0 8px rgba(39, 174, 96, 0.4); }
        .adv-btn.active[data-mode="dis"] { background: #c0392b; color: #fff; box-shadow: 0 0 8px rgba(192, 57, 43, 0.4); }
        .adv-btn.active[data-mode="norm"] { background: #2980b9; color: #fff; box-shadow: 0 0 8px rgba(41, 128, 185, 0.4); }

        .misc-wrapper { display: flex; align-items: center; gap: 5px; position: relative; }
        .misc-wrapper input { width: 40px; text-align: center; font-weight: bold; color: var(--misc); border: 1px solid #444; padding: 7px; background: #222; }
        .misc-label { font-size: 0.6rem; color: #888; text-transform: uppercase; position: absolute; top: -8px; left: 8px; background: #000; padding: 0 3px; }

        .log-area { font-family: monospace; font-size: 0.85rem; color: var(--accent); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; text-align: right; min-width: 150px; }

        /* GENERAL UI */
        .header-card { background: var(--card-bg); padding: 20px; border-radius: 12px; display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; border: 1px solid var(--border); }
        .webhook-row { grid-column: span 3; display: flex; gap: 10px; align-items: center; border-top: 1px solid #333; padding-top: 15px; margin-top: 5px; }
        
        .field-group { display: flex; flex-direction: column; }
        label { font-size: 0.75rem; color: #888; text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.5px; }
        input[type="text"], input[type="number"], select, textarea { background: var(--input-bg); border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 4px; font-size: 1rem; }
        input:focus, textarea:focus { outline: 1px solid var(--accent); border-color: var(--accent); }
        
        /* WEBHOOK INPUTS */
        .webhook-input { flex: 1; font-size: 0.8rem !important; color: #888 !important; }
        .webhook-input:focus { color: #fff !important; }
        .discord-toggle { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; cursor: pointer; color: #aaa; }
        .discord-toggle input { cursor: pointer; }
        .discord-active { color: #5865F2; font-weight: bold; }

        .read-only-box { background: #252525; border: 1px solid #333; color: #888; font-weight: bold; padding: 8px; border-radius: 4px; text-align: center; cursor: default; }

        /* ATTRIBUTES */
        .grid-6 { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; }
        .stat-card { background: var(--card-bg); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid var(--border); position: relative; }
        .stat-card h3 { margin: 0 0 5px 0; font-size: 0.9rem; color: #aaa; }
        .score-input { width: 40px; text-align: center; font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }
        .mod-display { font-size: 0.9rem; color: #888; margin-bottom: 5px; }
        .defense-box { background: #252525; padding: 5px; border-radius: 4px; margin-top: 5px; border-top: 2px solid var(--accent); }
        .defense-val { font-size: 1.4rem; font-weight: bold; color: var(--accent); }
        .defense-label { font-size: 0.6rem; text-transform: uppercase; color: #666; }
        .save-prof { display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 0.7rem; margin-top: 5px; cursor: pointer; }

        /* SKILLS */
        .section-title { margin: 10px 0 5px 0; color: #888; font-size: 0.9rem; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .skill-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 10px; }
        .skill-row { background: var(--card-bg); padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; gap: 10px; border: 1px solid var(--border); }
        .skill-name { flex: 1; font-size: 0.9rem; font-weight: 500; }
        .skill-bonus { width: 30px; text-align: right; font-weight: bold; color: #ddd; }
        .prof-toggle { cursor: pointer; opacity: 0.3; transition: 0.2s; font-size: 1.2rem; }
        .prof-toggle:hover { opacity: 0.7; }
        .prof-toggle.prof { opacity: 1; color: var(--accent); }
        .prof-toggle.exp { opacity: 1; color: #f1c40f; text-shadow: 0 0 5px rgba(241, 196, 15, 0.3); }

        .roll-btn { background: #333; border: none; color: #fff; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; transition: background 0.2s; }
        .roll-btn:hover { background: var(--accent); color: #000; }

        /* ATTACKS */
        .atk-row { display: grid; grid-template-columns: 1fr 60px 70px 30px 30px 30px; gap: 8px; margin-bottom: 8px; align-items: center; }
        .add-btn { background: var(--accent-atk); color: #000; border: none; padding: 8px; width: 100%; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .del-btn { color: #666; background: none; border: none; cursor: pointer; font-size: 1.2rem; }
        .del-btn:hover { color: var(--accent-atk); }
        .dmg-btn { background: #333; color: #ccc; border: 1px solid #444; width: 100%; border-radius: 4px; cursor: pointer; font-size: 0.8rem; height: 100%; }
        .dmg-btn:hover { background: #444; color: #fff; }

        /* SAVE LOAD */
        .io-card { background: #1a1a1a; padding: 15px; border-radius: 12px; border: 1px solid #444; margin-top: 20px; }
        .io-row { display: flex; gap: 10px; margin-top: 10px; }

        /* MOBILE TWEAK */
        @media (max-width: 600px) {
            .roller-bar { justify-content: space-between; }
            .log-area { display: none; } /* Hide log on tiny screens to save space */
        }
    </style>
</head>
<body>

<div class="roller-bar">
    <div class="adv-controls">
        <button class="adv-btn" onclick="setMode('dis')" data-mode="dis">DIS</button>
        <button class="adv-btn active" onclick="setMode('norm')" data-mode="norm"> - </button>
        <button class="adv-btn" onclick="setMode('adv')" data-mode="adv">ADV</button>
    </div>
    
    <div class="misc-wrapper">
        <span class="misc-label">Misc</span>
        <input type="number" id="globalMisc" placeholder="0">
    </div>

    <div id="logArea" class="log-area">Ready to roll...</div>
</div>

<div class="sheet-container">
    
    <div class="header-card">
        <div class="field-group">
            <label>Character Name</label>
            <input type="text" id="charName" oninput="save()">
        </div>
        <div class="field-group">
            <label>Level</label>
            <input type="number" id="charLevel" value="1" min="1" max="20" oninput="updateLevel(this.value)">
        </div>
        <div class="field-group">
            <label>Prof. Bonus</label>
            <div class="read-only-box" id="charPB">+2</div>
        </div>

        <div class="webhook-row">
            <input type="text" id="webhookUrl" class="webhook-input" placeholder="Paste Discord Webhook URL here..." oninput="save()">
            <label class="discord-toggle" id="discordLabel">
                <input type="checkbox" id="sendToDiscord" onchange="toggleDiscord(this.checked)"> 
                <span>Send to Discord</span>
            </label>
        </div>
    </div>

    <div>
        <div class="section-title">Attributes & Defenses (11 + Save)</div>
        <div class="grid-6" id="statsGrid"></div>
    </div>

    <div>
        <div class="section-title">Attacks (Unified Offense)</div>
        <div id="attackList"></div>
        <button class="add-btn" onclick="addAttack()">+ Add Weapon / Spell</button>
    </div>

    <div>
        <div class="section-title">Skills</div>
        <div class="skill-list" id="skillGrid"></div>
    </div>

    <div class="io-card">
        <div class="section-title" style="border:none; margin-top:0;">Backup Data</div>
        <textarea id="ioField" rows="3" placeholder="Export string will appear here, or paste one here to load..." style="font-family: monospace; color: var(--accent); resize: none;"></textarea>
        <div class="io-row">
            <button class="add-btn" style="background:#333; color:#fff;" onclick="exportData()">Export (Copy)</button>
            <button class="add-btn" style="background:var(--accent); color:#000;" onclick="importData()">Import (Load)</button>
        </div>
        <div id="ioMsg" style="text-align:center; color: var(--accent); font-size:0.8rem; margin-top:8px; height:1rem;"></div>
    </div>

</div>

<script>
    // --- CONFIG & STATE ---
    const stats = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
    const skillsMap = {
        'acrobatics': 'dex', 'animal handling': 'wis', 'arcana': 'int', 
        'athletics': 'str', 'deception': 'cha', 'history': 'int', 
        'insight': 'wis', 'intimidation': 'cha', 'investigation': 'int', 
        'medicine': 'wis', 'nature': 'int', 'perception': 'wis', 
        'performance': 'cha', 'persuasion': 'cha', 'religion': 'int', 
        'sleight of hand': 'dex', 'stealth': 'dex', 'survival': 'wis'
    };

    let data = {
        meta: { name: '', level: 1, webhook: '', discordActive: false },
        stats: {
            str: { val: 10, save: false }, dex: { val: 10, save: false },
            con: { val: 10, save: false }, int: { val: 10, save: false },
            wis: { val: 10, save: false }, cha: { val: 10, save: false }
        },
        skills: {}, 
        attacks: [],
        rollMode: 'norm'
    };

    // --- INIT ---
    function init() {
        const saved = localStorage.getItem('unifiedSheetDataV5');
        if (saved) {
            const parsed = JSON.parse(saved);
            data = { ...data, ...parsed, stats: { ...data.stats, ...parsed.stats } };
            
            document.getElementById('charName').value = data.meta.name || '';
            document.getElementById('charLevel').value = data.meta.level || 1;
            document.getElementById('webhookUrl').value = data.meta.webhook || '';
            document.getElementById('sendToDiscord').checked = data.meta.discordActive || false;
            toggleDiscord(data.meta.discordActive);
        } else {
            Object.keys(skillsMap).forEach(s => data.skills[s] = 0);
        }
        
        renderStats();
        renderSkills();
        renderAttacks();
        updateAll();
        setMode(data.rollMode || 'norm'); 
    }

    // --- RENDERERS ---
    function renderStats() {
        document.getElementById('statsGrid').innerHTML = stats.map(s => `
            <div class="stat-card">
                <h3>${s.toUpperCase()}</h3>
                <input type="number" class="score-input" value="${data.stats[s].val}" onchange="updateStat('${s}', this.value)">
                <div class="mod-display" id="mod-${s}">+0</div>
                <label class="save-prof"><input type="checkbox" ${data.stats[s].save ? 'checked' : ''} onchange="toggleSave('${s}')"> Save Prof</label>
                <div class="defense-box"><div class="defense-val" id="def-${s}">11</div><div class="defense-label">Defense</div></div>
                <button class="roll-btn" style="position:absolute; top:5px; right:5px;" onclick="rollCheck('${s}')">d20</button>
            </div>
        `).join('');
    }

    function renderSkills() {
        document.getElementById('skillGrid').innerHTML = Object.keys(skillsMap).map(s => {
            const state = data.skills[s] || 0; 
            const icon = state === 2 ? '‚óà' : (state === 1 ? '‚óÜ' : '‚óá');
            const cls = state === 2 ? 'exp' : (state === 1 ? 'prof' : '');
            return `
            <div class="skill-row">
                <span class="prof-toggle ${cls}" onclick="cycleSkill('${s}')">${icon}</span>
                <span class="skill-name">${s.charAt(0).toUpperCase() + s.slice(1)} <span style="color:#666;font-size:0.7em">(${skillsMap[s].substring(0,3).toUpperCase()})</span></span>
                <span class="skill-bonus" id="skill-bonus-${s}">+0</span>
                <button class="roll-btn" onclick="rollSkill('${s}')">üé≤</button>
            </div>`;
        }).join('');
    }

    function renderAttacks() {
        document.getElementById('attackList').innerHTML = data.attacks.map((atk, i) => `
            <div class="atk-row">
                <input type="text" placeholder="Weapon Name" value="${atk.name}" onchange="updateAttack(${i}, 'name', this.value)">
                <input type="text" placeholder="1d8" value="${atk.dmg}" onchange="updateAttack(${i}, 'dmg', this.value)">
                <select onchange="updateAttack(${i}, 'stat', this.value)">
                    ${stats.map(s => `<option value="${s}" ${atk.stat === s ? 'selected' : ''}>${s.toUpperCase()}</option>`).join('')}
                </select>
                <button class="dmg-btn" onclick="rollDamage(${i})" title="Roll Damage">ü©∏</button>
                <button class="roll-btn" style="width:100%" onclick="rollAttack(${i})" title="Attack Roll">‚öîÔ∏è</button>
                <button class="del-btn" onclick="delAttack(${i})">&times;</button>
            </div>
        `).join('');
    }

    // --- LOGIC ---
    function getMod(score) { return Math.floor((score - 10) / 2); }
    function getPB(level) { return Math.ceil(level / 4) + 1; }

    function updateLevel(val) {
        data.meta.level = Math.min(20, Math.max(1, parseInt(val)));
        save();
        updateAll();
    }

    function updateAll() {
        const pb = getPB(data.meta.level);
        document.getElementById('charPB').innerText = "+" + pb;
        stats.forEach(s => {
            const mod = getMod(data.stats[s].val);
            const saveBonus = mod + (data.stats[s].save ? pb : 0);
            document.getElementById(`mod-${s}`).innerText = (mod >= 0 ? "+" : "") + mod;
            document.getElementById(`def-${s}`).innerText = 11 + saveBonus;
        });
        Object.keys(skillsMap).forEach(s => {
            const stat = skillsMap[s];
            const mod = getMod(data.stats[stat].val);
            const profLevel = data.skills[s] || 0;
            const bonus = mod + (profLevel * pb);
            document.getElementById(`skill-bonus-${s}`).innerText = (bonus >= 0 ? "+" : "") + bonus;
        });
    }

    // --- ROLLING & DISCORD ---
    function toggleDiscord(active) {
        data.meta.discordActive = active;
        const label = document.getElementById('discordLabel');
        if(active) label.classList.add('discord-active');
        else label.classList.remove('discord-active');
        save();
    }

    function sendToDiscord(label, formulaStr, result, type = 'check') {
        if (!data.meta.discordActive || !data.meta.webhook) return;

        // Color coding: Cyan (5164484) for skills, Red (16739179) for attacks, Grey for dmg
        let color = 5164484; 
        if (type === 'atk') color = 16739179;
        if (type === 'dmg') color = 9807270;

        const charName = data.meta.name || "Adventurer";

        const payload = {
            username: charName,
            embeds: [{
                title: label,
                description: `**Result:** ${result}\n\n${formulaStr}`,
                color: color,
                footer: { text: "Unified 5e Roller" }
            }]
        };

        fetch(data.meta.webhook, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).catch(err => console.error("Discord Error:", err));
    }

    function setMode(mode) {
        data.rollMode = mode;
        save(); 
        document.querySelectorAll('.adv-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.adv-btn[data-mode="${mode}"]`).classList.add('active');
    }

    function rollDie(sides, bonus, label, allowAdvantage = true, type = 'check') {
        const miscInput = document.getElementById('globalMisc');
        const misc = parseInt(miscInput.value) || 0;
        
        let r1 = Math.floor(Math.random() * sides) + 1;
        let r2 = Math.floor(Math.random() * sides) + 1;
        let roll = r1;
        let formula = `[${r1}]`;
        let modeStr = "";

        if (allowAdvantage && sides === 20) {
            if (data.rollMode === 'adv') {
                roll = Math.max(r1, r2);
                formula = `[${r1}, ${r2}] (Keep High)`;
                modeStr = " (ADV)";
            } else if (data.rollMode === 'dis') {
                roll = Math.min(r1, r2);
                formula = `[${r1}, ${r2}] (Keep Low)`;
                modeStr = " (DIS)";
            }
        }

        const total = roll + bonus + misc;
        const sign = bonus >= 0 ? "+" : "";
        const miscSign = misc >= 0 ? "+" : "";
        
        let displayFormula = `${formula} ${sign}${bonus}`;
        if (misc !== 0) displayFormula += ` ${miscSign}${misc} (Misc)`;

        // UI Log
        document.getElementById('logArea').innerHTML = `<strong>${label}:</strong> ${displayFormula} = <span style="color:#fff;font-size:1.2em;font-weight:bold">${total}</span>`;
        
        // Discord Hook
        sendToDiscord(label + modeStr, `Dice: ${displayFormula}`, `**${total}**`, type);
    }

    function rollDamage(idx) {
        const atk = data.attacks[idx];
        const mod = getMod(data.stats[atk.stat].val);
        const dmgStr = atk.dmg || "1d4"; 
        
        const regex = /(\d+)d(\d+)/i;
        const match = dmgStr.match(regex);
        
        if (!match) {
            document.getElementById('logArea').innerHTML = `<span style="color:red">Invalid Dice Format</span>`;
            return;
        }

        const count = parseInt(match[1]);
        const sides = parseInt(match[2]);
        let total = 0;
        let rolls = [];

        for (let i = 0; i < count; i++) {
            let r = Math.floor(Math.random() * sides) + 1;
            total += r;
            rolls.push(r);
        }
        total += mod;
        
        const formulaStr = `[${rolls.join('+')}] + ${mod} (${atk.stat.toUpperCase()})`;
        
        document.getElementById('logArea').innerHTML = `<strong>${atk.name || 'Dmg'}:</strong> ${formulaStr} = <span style="color:#ff6b6b;font-size:1.3em;font-weight:bold">${total}</span>`;
        
        sendToDiscord((atk.name || 'Weapon') + " Damage", `Dice: ${formulaStr}`, `**${total}**`, 'dmg');
    }

    function rollCheck(stat) {
        const mod = getMod(data.stats[stat].val);
        rollDie(20, mod, stat.toUpperCase() + " Check", true, 'check');
    }

    function rollSkill(skill) {
        const stat = skillsMap[skill];
        const pb = getPB(data.meta.level);
        const mod = getMod(data.stats[stat].val);
        const profLevel = data.skills[skill] || 0;
        const bonus = mod + (profLevel * pb);
        rollDie(20, bonus, skill.charAt(0).toUpperCase() + skill.slice(1), true, 'check');
    }

    function rollAttack(idx) {
        const atk = data.attacks[idx];
        const pb = getPB(data.meta.level);
        const mod = getMod(data.stats[atk.stat].val);
        const bonus = mod + pb; 
        rollDie(20, bonus, (atk.name || 'Weapon') + " Atk", true, 'atk');
    }

    // --- PERSISTENCE ---
    function updateStat(stat, val) { data.stats[stat].val = parseInt(val); save(); updateAll(); }
    function toggleSave(stat) { data.stats[stat].save = !data.stats[stat].save; save(); updateAll(); }
    function cycleSkill(skill) { data.skills[skill] = ( (data.skills[skill] || 0) + 1) % 3; save(); renderSkills(); updateAll(); }
    function addAttack() { data.attacks.push({ name: '', stat: 'str', dmg: '1d8' }); save(); renderAttacks(); }
    function updateAttack(idx, field, val) { data.attacks[idx][field] = val; save(); }
    function delAttack(idx) { data.attacks.splice(idx, 1); save(); renderAttacks(); }
    
    function save() { 
        data.meta.name = document.getElementById('charName').value;
        data.meta.webhook = document.getElementById('webhookUrl').value;
        localStorage.setItem('unifiedSheetDataV5', JSON.stringify(data)); 
    }

    // --- IMPORT / EXPORT LOGIC ---
    function showIoMsg(txt) {
        const m = document.getElementById('ioMsg');
        m.innerText = txt;
        setTimeout(() => m.innerText = "", 3000);
    }

    function exportData() {
        save(); // Ensure state matches inputs
        try {
            const jsonStr = JSON.stringify(data);
            // Safe encode to handle emojis and unicode in names/weapons
            const base64 = btoa(encodeURIComponent(jsonStr).replace(/%([0-9A-F]{2})/g,
                function toSolidBytes(match, p1) {
                    return String.fromCharCode('0x' + p1);
            }));
            
            const field = document.getElementById('ioField');
            field.value = base64;
            field.select();
            field.setSelectionRange(0, 99999); // For mobile
            
            navigator.clipboard.writeText(base64).then(() => {
                showIoMsg("Save code copied to clipboard!");
            });
        } catch(e) {
            console.error(e);
            showIoMsg("Export failed.");
        }
    }

    function importData() {
        const field = document.getElementById('ioField');
        const str = field.value.trim();
        if(!str) return showIoMsg("Paste a save code first.");

        try {
            // Safe decode
            const jsonStr = decodeURIComponent(atob(str).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            
            const parsed = JSON.parse(jsonStr);
            data = parsed;
            
            // Re-sync UI
            document.getElementById('charName').value = data.meta.name || '';
            document.getElementById('charLevel').value = data.meta.level || 1;
            document.getElementById('webhookUrl').value = data.meta.webhook || '';
            document.getElementById('sendToDiscord').checked = data.meta.discordActive || false;
            
            toggleDiscord(data.meta.discordActive);
            renderStats();
            renderSkills();
            renderAttacks();
            updateAll();
            setMode(data.rollMode || 'norm');
            
            save(); // Commit to local storage
            field.value = "";
            showIoMsg("Character loaded successfully!");
        } catch(e) {
            console.error(e);
            showIoMsg("Invalid save code.");
        }
    }

    init();
</script>
</body>
</html>